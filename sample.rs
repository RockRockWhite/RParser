use serde::{Deserialize, Serialize};
use std::{collections::HashMap, error::Error, hash::Hash};

// declarations
// ======================

pub struct Foo {
    x: i32,
    y: i32,
}

// ======================

/// Token
/// must implement Clone and Token trait
/// Token trait is used to convert a token to a tree node
pub trait Token: Clone {
    fn to_tree_node(&self) -> ParsingTreeNode;
}

pub struct ParsingTreeNode {
    pub symbol_type: String,
    pub data: String,
    pub children: Vec<ParsingTreeNode>,
}

impl ParsingTreeNode {
    pub fn build(symbol_type: String, data: String, children: Vec<ParsingTreeNode>) -> Self {
        ParsingTreeNode {
            symbol_type,
            data,
            children,
        }
    }
}

/// NodePair
/// a pair of a node and a state.
/// (TreeNode, state)
pub struct NodePair(ParsingTreeNode, usize);
impl NodePair {
    pub fn new(node: ParsingTreeNode, state: usize) -> Self {
        NodePair(node, state)
    }
}

#[derive(Clone, Debug, Serialize, Deserialize)]
pub struct ReduceDerivation {
    pub left: String,
    pub right: Vec<String>,
}

impl PartialEq for ReduceDerivation {
    fn eq(&self, other: &Self) -> bool {
        self.left == other.left && self.right == other.right
    }
}

impl Eq for ReduceDerivation {}

impl Hash for ReduceDerivation {
    fn hash<H: std::hash::Hasher>(&self, state: &mut H) {
        self.left.hash(state);
        self.right.hash(state);
    }
}

impl ReduceDerivation {
    pub fn build(left: String, right: Vec<String>) -> Self {
        ReduceDerivation { left, right }
    }
}

#[derive(Debug, Serialize, Deserialize)]
pub enum Action {
    Shift(usize),
    Reduce(ReduceDerivation),
    Accept,
    Error,
}

#[derive(Serialize, Deserialize)]
pub struct State {
    pub actions: HashMap<String, Action>,
}

impl State {
    pub fn new() -> Self {
        State {
            actions: HashMap::new(),
        }
    }
}

#[derive(Serialize, Deserialize, Default)]
pub struct ActionTable {
    pub states: Vec<State>,
}

impl ActionTable {
    pub fn get_action(&self, state: usize, symbol: &str) -> Option<&Action> {
        self.states[state].actions.get(symbol)
    }
}

#[derive(Default)]
pub struct RParser {
    action_table: ActionTable,
    handlers: HashMap<ReduceDerivation, Box<dyn Fn(Vec<String>) -> String>>,
    // variables
    // ======================
    pub a: i32,
    pub b: i64,
    // ======================
}

impl RParser {
    pub const END_SYMBOL: &'static str = "__$__";
    pub const EPSILON_SYMBOL: &'static str = "__EPSILON__";
    pub const DUMMY_START_SYMBOL: &'static str = "__DUMMY_START__";

    pub fn new() -> Self {
        // action table generated by rparser
        // ======================
        let action_table: ActionTable =  serde_json::from_str(r#"{"states":[{"actions":{"program":{"Shift":3},"S":{"Shift":2},"block":{"Shift":1},"left_curly_brace":{"Shift":4},"__$__":"Accept"}},{"actions":{"__$__":{"Reduce":{"left":"program","right":["block"]}}}},{"actions":{"__$__":{"Reduce":{"left":"__DUMMY_START__","right":["S"]}}}},{"actions":{"__$__":{"Reduce":{"left":"S","right":["program"]}}}},{"actions":{"do":{"Shift":63},"block":{"Shift":5},"break":{"Shift":57},"while":{"Shift":59},"decls":{"Shift":81},"if":{"Shift":6},"left_curly_brace":{"Shift":4},"basic":{"Shift":78},"loc":{"Shift":64},"id":{"Shift":8},"stmts":{"Shift":79},"type":{"Shift":85}}},{"actions":{"id":{"Reduce":{"left":"stmt","right":["block"]}},"do":{"Reduce":{"left":"stmt","right":["block"]}},"if":{"Reduce":{"left":"stmt","right":["block"]}},"right_curly_brace":{"Reduce":{"left":"stmt","right":["block"]}},"left_curly_brace":{"Reduce":{"left":"stmt","right":["block"]}},"break":{"Reduce":{"left":"stmt","right":["block"]}},"while":{"Reduce":{"left":"stmt","right":["block"]}},"else":{"Reduce":{"left":"stmt","right":["block"]}}}},{"actions":{"(":{"Shift":7}}},{"actions":{"factor":{"Shift":21},"rel":{"Shift":50},"real":{"Shift":30},"unary":{"Shift":27},"id":{"Shift":8},"false":{"Shift":13},"equality":{"Shift":22},"bool":{"Shift":55},"term":{"Shift":37},"!":{"Shift":9},"true":{"Shift":11},"-":{"Shift":12},"(":{"Shift":14},"join":{"Shift":52},"num":{"Shift":10},"loc":{"Shift":15},"expr":{"Shift":25}}},{"actions":{")":{"Reduce":{"left":"loc","right":["id"]}},"/":{"Reduce":{"left":"loc","right":["id"]}},";":{"Reduce":{"left":"loc","right":["id"]}},"!=":{"Reduce":{"left":"loc","right":["id"]}},"<":{"Reduce":{"left":"loc","right":["id"]}},"-":{"Reduce":{"left":"loc","right":["id"]}},"+":{"Reduce":{"left":"loc","right":["id"]}},"[":{"Reduce":{"left":"loc","right":["id"]}},"*":{"Reduce":{"left":"loc","right":["id"]}},">":{"Reduce":{"left":"loc","right":["id"]}},">=":{"Reduce":{"left":"loc","right":["id"]}},"==":{"Reduce":{"left":"loc","right":["id"]}},"&&":{"Reduce":{"left":"loc","right":["id"]}},"<=":{"Reduce":{"left":"loc","right":["id"]}},"=":{"Reduce":{"left":"loc","right":["id"]}},"||":{"Reduce":{"left":"loc","right":["id"]}}}},{"actions":{"(":{"Shift":14},"!":{"Shift":9},"num":{"Shift":10},"loc":{"Shift":15},"false":{"Shift":13},"factor":{"Shift":21},"id":{"Shift":8},"real":{"Shift":30},"unary":{"Shift":54},"true":{"Shift":11},"-":{"Shift":12}}},{"actions":{";":{"Reduce":{"left":"factor","right":["num"]}},"*":{"Reduce":{"left":"factor","right":["num"]}},"-":{"Reduce":{"left":"factor","right":["num"]}},">":{"Reduce":{"left":"factor","right":["num"]}},"==":{"Reduce":{"left":"factor","right":["num"]}},"+":{"Reduce":{"left":"factor","right":["num"]}},"!=":{"Reduce":{"left":"factor","right":["num"]}},">=":{"Reduce":{"left":"factor","right":["num"]}},"<":{"Reduce":{"left":"factor","right":["num"]}},"&&":{"Reduce":{"left":"factor","right":["num"]}},")":{"Reduce":{"left":"factor","right":["num"]}},"<=":{"Reduce":{"left":"factor","right":["num"]}},"/":{"Reduce":{"left":"factor","right":["num"]}},"||":{"Reduce":{"left":"factor","right":["num"]}}}},{"actions":{"||":{"Reduce":{"left":"factor","right":["true"]}},">":{"Reduce":{"left":"factor","right":["true"]}},"-":{"Reduce":{"left":"factor","right":["true"]}},"*":{"Reduce":{"left":"factor","right":["true"]}},"<":{"Reduce":{"left":"factor","right":["true"]}},"&&":{"Reduce":{"left":"factor","right":["true"]}},")":{"Reduce":{"left":"factor","right":["true"]}},">=":{"Reduce":{"left":"factor","right":["true"]}},"!=":{"Reduce":{"left":"factor","right":["true"]}},"/":{"Reduce":{"left":"factor","right":["true"]}},"==":{"Reduce":{"left":"factor","right":["true"]}},"<=":{"Reduce":{"left":"factor","right":["true"]}},"+":{"Reduce":{"left":"factor","right":["true"]}},";":{"Reduce":{"left":"factor","right":["true"]}}}},{"actions":{"unary":{"Shift":53},"(":{"Shift":14},"num":{"Shift":10},"real":{"Shift":30},"!":{"Shift":9},"loc":{"Shift":15},"id":{"Shift":8},"factor":{"Shift":21},"false":{"Shift":13},"true":{"Shift":11},"-":{"Shift":12}}},{"actions":{"*":{"Reduce":{"left":"factor","right":["false"]}},"-":{"Reduce":{"left":"factor","right":["false"]}},"==":{"Reduce":{"left":"factor","right":["false"]}},";":{"Reduce":{"left":"factor","right":["false"]}},">=":{"Reduce":{"left":"factor","right":["false"]}},"!=":{"Reduce":{"left":"factor","right":["false"]}},"&&":{"Reduce":{"left":"factor","right":["false"]}},"<":{"Reduce":{"left":"factor","right":["false"]}},"/":{"Reduce":{"left":"factor","right":["false"]}},"<=":{"Reduce":{"left":"factor","right":["false"]}},"+":{"Reduce":{"left":"factor","right":["false"]}},")":{"Reduce":{"left":"factor","right":["false"]}},"||":{"Reduce":{"left":"factor","right":["false"]}},">":{"Reduce":{"left":"factor","right":["false"]}}}},{"actions":{"(":{"Shift":14},"true":{"Shift":11},"equality":{"Shift":22},"real":{"Shift":30},"loc":{"Shift":15},"unary":{"Shift":27},"!":{"Shift":9},"-":{"Shift":12},"join":{"Shift":52},"expr":{"Shift":25},"id":{"Shift":8},"rel":{"Shift":50},"num":{"Shift":10},"false":{"Shift":13},"term":{"Shift":37},"factor":{"Shift":21},"bool":{"Shift":19}}},{"actions":{"+":{"Reduce":{"left":"factor","right":["loc"]}},"<=":{"Reduce":{"left":"factor","right":["loc"]}},"<":{"Reduce":{"left":"factor","right":["loc"]}},">":{"Reduce":{"left":"factor","right":["loc"]}},"-":{"Reduce":{"left":"factor","right":["loc"]}},"!=":{"Reduce":{"left":"factor","right":["loc"]}},"[":{"Shift":16},"||":{"Reduce":{"left":"factor","right":["loc"]}},">=":{"Reduce":{"left":"factor","right":["loc"]}},")":{"Reduce":{"left":"factor","right":["loc"]}},"/":{"Reduce":{"left":"factor","right":["loc"]}},";":{"Reduce":{"left":"factor","right":["loc"]}},"&&":{"Reduce":{"left":"factor","right":["loc"]}},"*":{"Reduce":{"left":"factor","right":["loc"]}},"==":{"Reduce":{"left":"factor","right":["loc"]}}}},{"actions":{"num":{"Shift":17}}},{"actions":{"]":{"Shift":18}}},{"actions":{"-":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"<":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},")":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},";":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"<=":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"||":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"!=":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"/":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"=":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},">":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},">=":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"[":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"*":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"&&":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"==":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}},"+":{"Reduce":{"left":"loc","right":["loc","[","num","]"]}}}},{"actions":{")":{"Shift":51},"||":{"Shift":20}}},{"actions":{"term":{"Shift":37},"unary":{"Shift":27},"id":{"Shift":8},"factor":{"Shift":21},"-":{"Shift":12},"join":{"Shift":47},"false":{"Shift":13},"equality":{"Shift":22},"(":{"Shift":14},"loc":{"Shift":15},"true":{"Shift":11},"num":{"Shift":10},"!":{"Shift":9},"real":{"Shift":30},"expr":{"Shift":25},"rel":{"Shift":50}}},{"actions":{"&&":{"Reduce":{"left":"unary","right":["factor"]}},"==":{"Reduce":{"left":"unary","right":["factor"]}},">":{"Reduce":{"left":"unary","right":["factor"]}},"+":{"Reduce":{"left":"unary","right":["factor"]}},"/":{"Reduce":{"left":"unary","right":["factor"]}},"<":{"Reduce":{"left":"unary","right":["factor"]}},"||":{"Reduce":{"left":"unary","right":["factor"]}},">=":{"Reduce":{"left":"unary","right":["factor"]}},"-":{"Reduce":{"left":"unary","right":["factor"]}},"*":{"Reduce":{"left":"unary","right":["factor"]}},"<=":{"Reduce":{"left":"unary","right":["factor"]}},";":{"Reduce":{"left":"unary","right":["factor"]}},")":{"Reduce":{"left":"unary","right":["factor"]}},"!=":{"Reduce":{"left":"unary","right":["factor"]}}}},{"actions":{"&&":{"Reduce":{"left":"join","right":["equality"]}},")":{"Reduce":{"left":"join","right":["equality"]}},"||":{"Reduce":{"left":"join","right":["equality"]}},";":{"Reduce":{"left":"join","right":["equality"]}},"==":{"Shift":23},"!=":{"Shift":45}}},{"actions":{"term":{"Shift":37},"unary":{"Shift":27},"-":{"Shift":12},"num":{"Shift":10},"true":{"Shift":11},"real":{"Shift":30},"rel":{"Shift":24},"loc":{"Shift":15},"id":{"Shift":8},"(":{"Shift":14},"!":{"Shift":9},"false":{"Shift":13},"factor":{"Shift":21},"expr":{"Shift":25}}},{"actions":{"||":{"Reduce":{"left":"equality","right":["equality","==","rel"]}},"!=":{"Reduce":{"left":"equality","right":["equality","==","rel"]}},"==":{"Reduce":{"left":"equality","right":["equality","==","rel"]}},")":{"Reduce":{"left":"equality","right":["equality","==","rel"]}},"&&":{"Reduce":{"left":"equality","right":["equality","==","rel"]}},";":{"Reduce":{"left":"equality","right":["equality","==","rel"]}}}},{"actions":{">":{"Shift":43},";":{"Reduce":{"left":"rel","right":["expr"]}},"<":{"Shift":36},"!=":{"Reduce":{"left":"rel","right":["expr"]}},"&&":{"Reduce":{"left":"rel","right":["expr"]}},"==":{"Reduce":{"left":"rel","right":["expr"]}},"-":{"Shift":34},")":{"Reduce":{"left":"rel","right":["expr"]}},"<=":{"Shift":39},"+":{"Shift":26},"||":{"Reduce":{"left":"rel","right":["expr"]}},">=":{"Shift":41}}},{"actions":{"num":{"Shift":10},"term":{"Shift":28},"factor":{"Shift":21},"!":{"Shift":9},"-":{"Shift":12},"(":{"Shift":14},"loc":{"Shift":15},"true":{"Shift":11},"id":{"Shift":8},"false":{"Shift":13},"unary":{"Shift":27},"real":{"Shift":30}}},{"actions":{";":{"Reduce":{"left":"term","right":["unary"]}},"||":{"Reduce":{"left":"term","right":["unary"]}},"*":{"Reduce":{"left":"term","right":["unary"]}},">=":{"Reduce":{"left":"term","right":["unary"]}},"<":{"Reduce":{"left":"term","right":["unary"]}},"&&":{"Reduce":{"left":"term","right":["unary"]}},"+":{"Reduce":{"left":"term","right":["unary"]}},"!=":{"Reduce":{"left":"term","right":["unary"]}},"<=":{"Reduce":{"left":"term","right":["unary"]}},"/":{"Reduce":{"left":"term","right":["unary"]}},"==":{"Reduce":{"left":"term","right":["unary"]}},">":{"Reduce":{"left":"term","right":["unary"]}},"-":{"Reduce":{"left":"term","right":["unary"]}},")":{"Reduce":{"left":"term","right":["unary"]}}}},{"actions":{"*":{"Shift":32},"<=":{"Reduce":{"left":"expr","right":["expr","+","term"]}},"+":{"Reduce":{"left":"expr","right":["expr","+","term"]}},"!=":{"Reduce":{"left":"expr","right":["expr","+","term"]}},">=":{"Reduce":{"left":"expr","right":["expr","+","term"]}},"==":{"Reduce":{"left":"expr","right":["expr","+","term"]}},"-":{"Reduce":{"left":"expr","right":["expr","+","term"]}},"<":{"Reduce":{"left":"expr","right":["expr","+","term"]}},">":{"Reduce":{"left":"expr","right":["expr","+","term"]}},"&&":{"Reduce":{"left":"expr","right":["expr","+","term"]}},")":{"Reduce":{"left":"expr","right":["expr","+","term"]}},";":{"Reduce":{"left":"expr","right":["expr","+","term"]}},"/":{"Shift":29},"||":{"Reduce":{"left":"expr","right":["expr","+","term"]}}}},{"actions":{"num":{"Shift":10},"real":{"Shift":30},"true":{"Shift":11},"false":{"Shift":13},"-":{"Shift":12},"!":{"Shift":9},"unary":{"Shift":31},"(":{"Shift":14},"factor":{"Shift":21},"id":{"Shift":8},"loc":{"Shift":15}}},{"actions":{"<=":{"Reduce":{"left":"factor","right":["real"]}},"==":{"Reduce":{"left":"factor","right":["real"]}},"+":{"Reduce":{"left":"factor","right":["real"]}},">=":{"Reduce":{"left":"factor","right":["real"]}},"/":{"Reduce":{"left":"factor","right":["real"]}},">":{"Reduce":{"left":"factor","right":["real"]}},"-":{"Reduce":{"left":"factor","right":["real"]}},"||":{"Reduce":{"left":"factor","right":["real"]}},"*":{"Reduce":{"left":"factor","right":["real"]}},")":{"Reduce":{"left":"factor","right":["real"]}},";":{"Reduce":{"left":"factor","right":["real"]}},"<":{"Reduce":{"left":"factor","right":["real"]}},"!=":{"Reduce":{"left":"factor","right":["real"]}},"&&":{"Reduce":{"left":"factor","right":["real"]}}}},{"actions":{"-":{"Reduce":{"left":"term","right":["term","/","unary"]}},"+":{"Reduce":{"left":"term","right":["term","/","unary"]}},"*":{"Reduce":{"left":"term","right":["term","/","unary"]}},"<=":{"Reduce":{"left":"term","right":["term","/","unary"]}},">=":{"Reduce":{"left":"term","right":["term","/","unary"]}},"/":{"Reduce":{"left":"term","right":["term","/","unary"]}},"<":{"Reduce":{"left":"term","right":["term","/","unary"]}},";":{"Reduce":{"left":"term","right":["term","/","unary"]}},")":{"Reduce":{"left":"term","right":["term","/","unary"]}},"&&":{"Reduce":{"left":"term","right":["term","/","unary"]}},">":{"Reduce":{"left":"term","right":["term","/","unary"]}},"==":{"Reduce":{"left":"term","right":["term","/","unary"]}},"!=":{"Reduce":{"left":"term","right":["term","/","unary"]}},"||":{"Reduce":{"left":"term","right":["term","/","unary"]}}}},{"actions":{"(":{"Shift":14},"loc":{"Shift":15},"true":{"Shift":11},"num":{"Shift":10},"factor":{"Shift":21},"!":{"Shift":9},"false":{"Shift":13},"id":{"Shift":8},"unary":{"Shift":33},"real":{"Shift":30},"-":{"Shift":12}}},{"actions":{"+":{"Reduce":{"left":"term","right":["term","*","unary"]}},"||":{"Reduce":{"left":"term","right":["term","*","unary"]}},"<=":{"Reduce":{"left":"term","right":["term","*","unary"]}},">=":{"Reduce":{"left":"term","right":["term","*","unary"]}},"-":{"Reduce":{"left":"term","right":["term","*","unary"]}},"/":{"Reduce":{"left":"term","right":["term","*","unary"]}},";":{"Reduce":{"left":"term","right":["term","*","unary"]}},")":{"Reduce":{"left":"term","right":["term","*","unary"]}},"*":{"Reduce":{"left":"term","right":["term","*","unary"]}},"!=":{"Reduce":{"left":"term","right":["term","*","unary"]}},"<":{"Reduce":{"left":"term","right":["term","*","unary"]}},">":{"Reduce":{"left":"term","right":["term","*","unary"]}},"==":{"Reduce":{"left":"term","right":["term","*","unary"]}},"&&":{"Reduce":{"left":"term","right":["term","*","unary"]}}}},{"actions":{"-":{"Shift":12},"unary":{"Shift":27},"(":{"Shift":14},"true":{"Shift":11},"loc":{"Shift":15},"false":{"Shift":13},"num":{"Shift":10},"factor":{"Shift":21},"real":{"Shift":30},"term":{"Shift":35},"id":{"Shift":8},"!":{"Shift":9}}},{"actions":{">=":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"||":{"Reduce":{"left":"expr","right":["expr","-","term"]}},";":{"Reduce":{"left":"expr","right":["expr","-","term"]}},")":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"+":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"==":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"*":{"Shift":32},"&&":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"<=":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"<":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"!=":{"Reduce":{"left":"expr","right":["expr","-","term"]}},">":{"Reduce":{"left":"expr","right":["expr","-","term"]}},"/":{"Shift":29},"-":{"Reduce":{"left":"expr","right":["expr","-","term"]}}}},{"actions":{"loc":{"Shift":15},"term":{"Shift":37},"expr":{"Shift":38},"id":{"Shift":8},"factor":{"Shift":21},"!":{"Shift":9},"true":{"Shift":11},"(":{"Shift":14},"num":{"Shift":10},"false":{"Shift":13},"unary":{"Shift":27},"real":{"Shift":30},"-":{"Shift":12}}},{"actions":{">=":{"Reduce":{"left":"expr","right":["term"]}},";":{"Reduce":{"left":"expr","right":["term"]}},"*":{"Shift":32},"+":{"Reduce":{"left":"expr","right":["term"]}},">":{"Reduce":{"left":"expr","right":["term"]}},"/":{"Shift":29},"||":{"Reduce":{"left":"expr","right":["term"]}},"<":{"Reduce":{"left":"expr","right":["term"]}},"&&":{"Reduce":{"left":"expr","right":["term"]}},"==":{"Reduce":{"left":"expr","right":["term"]}},")":{"Reduce":{"left":"expr","right":["term"]}},"<=":{"Reduce":{"left":"expr","right":["term"]}},"-":{"Reduce":{"left":"expr","right":["term"]}},"!=":{"Reduce":{"left":"expr","right":["term"]}}}},{"actions":{"+":{"Shift":26},"||":{"Reduce":{"left":"rel","right":["expr","<","expr"]}},";":{"Reduce":{"left":"rel","right":["expr","<","expr"]}},"&&":{"Reduce":{"left":"rel","right":["expr","<","expr"]}},"!=":{"Reduce":{"left":"rel","right":["expr","<","expr"]}},")":{"Reduce":{"left":"rel","right":["expr","<","expr"]}},"==":{"Reduce":{"left":"rel","right":["expr","<","expr"]}},"-":{"Shift":34}}},{"actions":{"true":{"Shift":11},"false":{"Shift":13},"!":{"Shift":9},"id":{"Shift":8},"term":{"Shift":37},"factor":{"Shift":21},"real":{"Shift":30},"(":{"Shift":14},"expr":{"Shift":40},"num":{"Shift":10},"-":{"Shift":12},"unary":{"Shift":27},"loc":{"Shift":15}}},{"actions":{"-":{"Shift":34},"||":{"Reduce":{"left":"rel","right":["expr","<=","expr"]}},"!=":{"Reduce":{"left":"rel","right":["expr","<=","expr"]}},";":{"Reduce":{"left":"rel","right":["expr","<=","expr"]}},"==":{"Reduce":{"left":"rel","right":["expr","<=","expr"]}},")":{"Reduce":{"left":"rel","right":["expr","<=","expr"]}},"&&":{"Reduce":{"left":"rel","right":["expr","<=","expr"]}},"+":{"Shift":26}}},{"actions":{"id":{"Shift":8},"(":{"Shift":14},"loc":{"Shift":15},"expr":{"Shift":42},"true":{"Shift":11},"real":{"Shift":30},"factor":{"Shift":21},"num":{"Shift":10},"unary":{"Shift":27},"false":{"Shift":13},"-":{"Shift":12},"!":{"Shift":9},"term":{"Shift":37}}},{"actions":{"-":{"Shift":34},"==":{"Reduce":{"left":"rel","right":["expr",">=","expr"]}},"&&":{"Reduce":{"left":"rel","right":["expr",">=","expr"]}},";":{"Reduce":{"left":"rel","right":["expr",">=","expr"]}},"+":{"Shift":26},"||":{"Reduce":{"left":"rel","right":["expr",">=","expr"]}},"!=":{"Reduce":{"left":"rel","right":["expr",">=","expr"]}},")":{"Reduce":{"left":"rel","right":["expr",">=","expr"]}}}},{"actions":{"loc":{"Shift":15},"true":{"Shift":11},"-":{"Shift":12},"num":{"Shift":10},"(":{"Shift":14},"real":{"Shift":30},"false":{"Shift":13},"id":{"Shift":8},"term":{"Shift":37},"factor":{"Shift":21},"unary":{"Shift":27},"!":{"Shift":9},"expr":{"Shift":44}}},{"actions":{"-":{"Shift":34},"&&":{"Reduce":{"left":"rel","right":["expr",">","expr"]}},")":{"Reduce":{"left":"rel","right":["expr",">","expr"]}},";":{"Reduce":{"left":"rel","right":["expr",">","expr"]}},"+":{"Shift":26},"!=":{"Reduce":{"left":"rel","right":["expr",">","expr"]}},"||":{"Reduce":{"left":"rel","right":["expr",">","expr"]}},"==":{"Reduce":{"left":"rel","right":["expr",">","expr"]}}}},{"actions":{"false":{"Shift":13},"factor":{"Shift":21},"rel":{"Shift":46},"-":{"Shift":12},"num":{"Shift":10},"term":{"Shift":37},"id":{"Shift":8},"(":{"Shift":14},"!":{"Shift":9},"unary":{"Shift":27},"real":{"Shift":30},"loc":{"Shift":15},"expr":{"Shift":25},"true":{"Shift":11}}},{"actions":{"||":{"Reduce":{"left":"equality","right":["equality","!=","rel"]}},"==":{"Reduce":{"left":"equality","right":["equality","!=","rel"]}},"&&":{"Reduce":{"left":"equality","right":["equality","!=","rel"]}},"!=":{"Reduce":{"left":"equality","right":["equality","!=","rel"]}},";":{"Reduce":{"left":"equality","right":["equality","!=","rel"]}},")":{"Reduce":{"left":"equality","right":["equality","!=","rel"]}}}},{"actions":{"||":{"Reduce":{"left":"bool","right":["bool","||","join"]}},"&&":{"Shift":48},";":{"Reduce":{"left":"bool","right":["bool","||","join"]}},")":{"Reduce":{"left":"bool","right":["bool","||","join"]}}}},{"actions":{"loc":{"Shift":15},"expr":{"Shift":25},"!":{"Shift":9},"true":{"Shift":11},"term":{"Shift":37},"num":{"Shift":10},"factor":{"Shift":21},"(":{"Shift":14},"false":{"Shift":13},"-":{"Shift":12},"real":{"Shift":30},"unary":{"Shift":27},"rel":{"Shift":50},"id":{"Shift":8},"equality":{"Shift":49}}},{"actions":{"&&":{"Reduce":{"left":"join","right":["join","&&","equality"]}},"==":{"Shift":23},")":{"Reduce":{"left":"join","right":["join","&&","equality"]}},"||":{"Reduce":{"left":"join","right":["join","&&","equality"]}},"!=":{"Shift":45},";":{"Reduce":{"left":"join","right":["join","&&","equality"]}}}},{"actions":{"&&":{"Reduce":{"left":"equality","right":["rel"]}},"!=":{"Reduce":{"left":"equality","right":["rel"]}},"==":{"Reduce":{"left":"equality","right":["rel"]}},")":{"Reduce":{"left":"equality","right":["rel"]}},";":{"Reduce":{"left":"equality","right":["rel"]}},"||":{"Reduce":{"left":"equality","right":["rel"]}}}},{"actions":{")":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"-":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"/":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"*":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"!=":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"&&":{"Reduce":{"left":"factor","right":["(","bool",")"]}},">":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"+":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"||":{"Reduce":{"left":"factor","right":["(","bool",")"]}},">=":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"<":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"==":{"Reduce":{"left":"factor","right":["(","bool",")"]}},"<=":{"Reduce":{"left":"factor","right":["(","bool",")"]}},";":{"Reduce":{"left":"factor","right":["(","bool",")"]}}}},{"actions":{";":{"Reduce":{"left":"bool","right":["join"]}},"&&":{"Shift":48},"||":{"Reduce":{"left":"bool","right":["join"]}},")":{"Reduce":{"left":"bool","right":["join"]}}}},{"actions":{"+":{"Reduce":{"left":"unary","right":["-","unary"]}},")":{"Reduce":{"left":"unary","right":["-","unary"]}},"==":{"Reduce":{"left":"unary","right":["-","unary"]}},"||":{"Reduce":{"left":"unary","right":["-","unary"]}},">=":{"Reduce":{"left":"unary","right":["-","unary"]}},"!=":{"Reduce":{"left":"unary","right":["-","unary"]}},"&&":{"Reduce":{"left":"unary","right":["-","unary"]}},"-":{"Reduce":{"left":"unary","right":["-","unary"]}},"*":{"Reduce":{"left":"unary","right":["-","unary"]}},"<=":{"Reduce":{"left":"unary","right":["-","unary"]}},";":{"Reduce":{"left":"unary","right":["-","unary"]}},">":{"Reduce":{"left":"unary","right":["-","unary"]}},"/":{"Reduce":{"left":"unary","right":["-","unary"]}},"<":{"Reduce":{"left":"unary","right":["-","unary"]}}}},{"actions":{"<=":{"Reduce":{"left":"unary","right":["!","unary"]}},"!=":{"Reduce":{"left":"unary","right":["!","unary"]}},"||":{"Reduce":{"left":"unary","right":["!","unary"]}},";":{"Reduce":{"left":"unary","right":["!","unary"]}},"/":{"Reduce":{"left":"unary","right":["!","unary"]}},"==":{"Reduce":{"left":"unary","right":["!","unary"]}},"+":{"Reduce":{"left":"unary","right":["!","unary"]}},">":{"Reduce":{"left":"unary","right":["!","unary"]}},">=":{"Reduce":{"left":"unary","right":["!","unary"]}},"&&":{"Reduce":{"left":"unary","right":["!","unary"]}},"-":{"Reduce":{"left":"unary","right":["!","unary"]}},"<":{"Reduce":{"left":"unary","right":["!","unary"]}},"*":{"Reduce":{"left":"unary","right":["!","unary"]}},")":{"Reduce":{"left":"unary","right":["!","unary"]}}}},{"actions":{"||":{"Shift":20},")":{"Shift":56}}},{"actions":{"break":{"Shift":57},"stmt":{"Shift":75},"left_curly_brace":{"Shift":4},"do":{"Shift":63},"while":{"Shift":59},"if":{"Shift":6},"block":{"Shift":5},"id":{"Shift":8},"loc":{"Shift":64}}},{"actions":{";":{"Shift":58}}},{"actions":{"if":{"Reduce":{"left":"stmt","right":["break",";"]}},"do":{"Reduce":{"left":"stmt","right":["break",";"]}},"id":{"Reduce":{"left":"stmt","right":["break",";"]}},"while":{"Reduce":{"left":"stmt","right":["break",";"]}},"else":{"Reduce":{"left":"stmt","right":["break",";"]}},"left_curly_brace":{"Reduce":{"left":"stmt","right":["break",";"]}},"break":{"Reduce":{"left":"stmt","right":["break",";"]}},"right_curly_brace":{"Reduce":{"left":"stmt","right":["break",";"]}}}},{"actions":{"(":{"Shift":60}}},{"actions":{"loc":{"Shift":15},"rel":{"Shift":50},"id":{"Shift":8},"real":{"Shift":30},"equality":{"Shift":22},"term":{"Shift":37},"!":{"Shift":9},"true":{"Shift":11},"expr":{"Shift":25},"(":{"Shift":14},"false":{"Shift":13},"factor":{"Shift":21},"bool":{"Shift":61},"-":{"Shift":12},"num":{"Shift":10},"join":{"Shift":52},"unary":{"Shift":27}}},{"actions":{")":{"Shift":62},"||":{"Shift":20}}},{"actions":{"do":{"Shift":63},"id":{"Shift":8},"if":{"Shift":6},"left_curly_brace":{"Shift":4},"loc":{"Shift":64},"stmt":{"Shift":74},"block":{"Shift":5},"break":{"Shift":57},"while":{"Shift":59}}},{"actions":{"break":{"Shift":57},"stmt":{"Shift":68},"do":{"Shift":63},"while":{"Shift":59},"block":{"Shift":5},"if":{"Shift":6},"loc":{"Shift":64},"left_curly_brace":{"Shift":4},"id":{"Shift":8}}},{"actions":{"=":{"Shift":65},"[":{"Shift":16}}},{"actions":{"real":{"Shift":30},"-":{"Shift":12},"term":{"Shift":37},"unary":{"Shift":27},"id":{"Shift":8},"expr":{"Shift":25},"equality":{"Shift":22},"loc":{"Shift":15},"bool":{"Shift":66},"num":{"Shift":10},"(":{"Shift":14},"rel":{"Shift":50},"true":{"Shift":11},"factor":{"Shift":21},"!":{"Shift":9},"false":{"Shift":13},"join":{"Shift":52}}},{"actions":{";":{"Shift":67},"||":{"Shift":20}}},{"actions":{"else":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}},"while":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}},"if":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}},"id":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}},"right_curly_brace":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}},"do":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}},"left_curly_brace":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}},"break":{"Reduce":{"left":"stmt","right":["loc","=","bool",";"]}}}},{"actions":{"while":{"Shift":69}}},{"actions":{"(":{"Shift":70}}},{"actions":{"-":{"Shift":12},"real":{"Shift":30},"term":{"Shift":37},"factor":{"Shift":21},"equality":{"Shift":22},"loc":{"Shift":15},"true":{"Shift":11},"unary":{"Shift":27},"num":{"Shift":10},"join":{"Shift":52},"!":{"Shift":9},"false":{"Shift":13},"bool":{"Shift":71},"expr":{"Shift":25},"id":{"Shift":8},"(":{"Shift":14},"rel":{"Shift":50}}},{"actions":{"||":{"Shift":20},")":{"Shift":72}}},{"actions":{";":{"Shift":73}}},{"actions":{"left_curly_brace":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}},"break":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}},"if":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}},"right_curly_brace":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}},"else":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}},"do":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}},"id":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}},"while":{"Reduce":{"left":"stmt","right":["do","stmt","while","(","bool",")",";"]}}}},{"actions":{"left_curly_brace":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}},"else":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}},"while":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}},"id":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}},"do":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}},"if":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}},"right_curly_brace":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}},"break":{"Reduce":{"left":"stmt","right":["while","(","bool",")","stmt"]}}}},{"actions":{"id":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}},"do":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}},"else":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}},"right_curly_brace":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}},"while":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}},"left_curly_brace":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}},"if":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}},"break":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt"]}}}},{"actions":{"left_curly_brace":{"Shift":4},"block":{"Shift":5},"break":{"Shift":57},"do":{"Shift":63},"id":{"Shift":8},"stmt":{"Shift":77},"while":{"Shift":59},"loc":{"Shift":64},"if":{"Shift":6}}},{"actions":{"while":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}},"id":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}},"else":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}},"left_curly_brace":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}},"break":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}},"right_curly_brace":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}},"do":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}},"if":{"Reduce":{"left":"stmt","right":["if","(","bool",")","stmt","else","stmt"]}}}},{"actions":{"[":{"Reduce":{"left":"type","right":["basic"]}},"id":{"Reduce":{"left":"type","right":["basic"]}}}},{"actions":{"while":{"Shift":59},"break":{"Shift":57},"stmt":{"Shift":80},"do":{"Shift":63},"left_curly_brace":{"Shift":4},"block":{"Shift":5},"loc":{"Shift":64},"if":{"Shift":6},"id":{"Shift":8}}},{"actions":{"if":{"Reduce":{"left":"stmts","right":["stmts","stmt"]}},"break":{"Reduce":{"left":"stmts","right":["stmts","stmt"]}},"left_curly_brace":{"Reduce":{"left":"stmts","right":["stmts","stmt"]}},"id":{"Reduce":{"left":"stmts","right":["stmts","stmt"]}},"while":{"Reduce":{"left":"stmts","right":["stmts","stmt"]}},"right_curly_brace":{"Reduce":{"left":"stmts","right":["stmts","stmt"]}},"do":{"Reduce":{"left":"stmts","right":["stmts","stmt"]}}}},{"actions":{"decl":{"Shift":84},"break":{"Shift":57},"type":{"Shift":85},"while":{"Shift":59},"if":{"Shift":6},"id":{"Shift":8},"do":{"Shift":63},"left_curly_brace":{"Shift":4},"loc":{"Shift":64},"stmts":{"Shift":82},"basic":{"Shift":78},"block":{"Shift":5}}},{"actions":{"do":{"Shift":63},"while":{"Shift":59},"if":{"Shift":6},"loc":{"Shift":64},"break":{"Shift":57},"id":{"Shift":8},"stmt":{"Shift":80},"left_curly_brace":{"Shift":4},"block":{"Shift":5},"right_curly_brace":{"Shift":83}}},{"actions":{"right_curly_brace":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"left_curly_brace":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"id":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"else":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"break":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"__$__":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"do":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"if":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}},"while":{"Reduce":{"left":"block","right":["left_curly_brace","decls","stmts","right_curly_brace"]}}}},{"actions":{"break":{"Reduce":{"left":"decls","right":["decls","decl"]}},"if":{"Reduce":{"left":"decls","right":["decls","decl"]}},"id":{"Reduce":{"left":"decls","right":["decls","decl"]}},"basic":{"Reduce":{"left":"decls","right":["decls","decl"]}},"while":{"Reduce":{"left":"decls","right":["decls","decl"]}},"left_curly_brace":{"Reduce":{"left":"decls","right":["decls","decl"]}},"do":{"Reduce":{"left":"decls","right":["decls","decl"]}}}},{"actions":{"id":{"Shift":86},"[":{"Shift":88}}},{"actions":{";":{"Shift":87}}},{"actions":{"left_curly_brace":{"Reduce":{"left":"decl","right":["type","id",";"]}},"do":{"Reduce":{"left":"decl","right":["type","id",";"]}},"while":{"Reduce":{"left":"decl","right":["type","id",";"]}},"id":{"Reduce":{"left":"decl","right":["type","id",";"]}},"if":{"Reduce":{"left":"decl","right":["type","id",";"]}},"break":{"Reduce":{"left":"decl","right":["type","id",";"]}},"basic":{"Reduce":{"left":"decl","right":["type","id",";"]}}}},{"actions":{"num":{"Shift":89}}},{"actions":{"]":{"Shift":90}}},{"actions":{"[":{"Reduce":{"left":"type","right":["type","[","num","]"]}},"id":{"Reduce":{"left":"type","right":["type","[","num","]"]}}}}]}"#).unwrap();
        // ======================

        let mut handlers: HashMap<ReduceDerivation, Box<dyn Fn(Vec<String>) -> String>> =
            HashMap::new();

        // handlers generated by rparser
        // ======================
        handlers.insert(
            ReduceDerivation::build("S".into(), vec!["program".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("program".into(), vec!["block".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "block".into(),
                vec![
                    "left_curly_brace".into(),
                    "decls".into(),
                    "stmts".into(),
                    "right_curly_brace".into(),
                ],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("decls".into(), vec!["decls".into(), "decl".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("decls".into(), vec!["__EPSILON__".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("decl".into(), vec!["type".into(), "id".into(), ";".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "type".into(),
                vec!["type".into(), "[".into(), "num".into(), "]".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("type".into(), vec!["basic".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("stmts".into(), vec!["stmts".into(), "stmt".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("stmts".into(), vec!["__EPSILON__".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "stmt".into(),
                vec!["loc".into(), "=".into(), "bool".into(), ";".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "stmt".into(),
                vec![
                    "if".into(),
                    "(".into(),
                    "bool".into(),
                    ")".into(),
                    "stmt".into(),
                ],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "stmt".into(),
                vec![
                    "if".into(),
                    "(".into(),
                    "bool".into(),
                    ")".into(),
                    "stmt".into(),
                    "else".into(),
                    "stmt".into(),
                ],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "stmt".into(),
                vec![
                    "while".into(),
                    "(".into(),
                    "bool".into(),
                    ")".into(),
                    "stmt".into(),
                ],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "stmt".into(),
                vec![
                    "do".into(),
                    "stmt".into(),
                    "while".into(),
                    "(".into(),
                    "bool".into(),
                    ")".into(),
                    ";".into(),
                ],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("stmt".into(), vec!["break".into(), ";".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("stmt".into(), vec!["block".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "loc".into(),
                vec!["loc".into(), "[".into(), "num".into(), "]".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("loc".into(), vec!["id".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "bool".into(),
                vec!["bool".into(), "||".into(), "join".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("bool".into(), vec!["join".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "join".into(),
                vec!["join".into(), "&&".into(), "equality".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("join".into(), vec!["equality".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "equality".into(),
                vec!["equality".into(), "==".into(), "rel".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "equality".into(),
                vec!["equality".into(), "!=".into(), "rel".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("equality".into(), vec!["rel".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("rel".into(), vec!["expr".into(), "<".into(), "expr".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "rel".into(),
                vec!["expr".into(), "<=".into(), "expr".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "rel".into(),
                vec!["expr".into(), ">=".into(), "expr".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("rel".into(), vec!["expr".into(), ">".into(), "expr".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("rel".into(), vec!["expr".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "expr".into(),
                vec!["expr".into(), "+".into(), "term".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "expr".into(),
                vec!["expr".into(), "-".into(), "term".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("expr".into(), vec!["term".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "term".into(),
                vec!["term".into(), "*".into(), "unary".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build(
                "term".into(),
                vec!["term".into(), "/".into(), "unary".into()],
            ),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("term".into(), vec!["unary".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("unary".into(), vec!["!".into(), "unary".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("unary".into(), vec!["-".into(), "unary".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("unary".into(), vec!["factor".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("factor".into(), vec!["(".into(), "bool".into(), ")".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("factor".into(), vec!["loc".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("factor".into(), vec!["num".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("factor".into(), vec!["real".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("factor".into(), vec!["true".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        handlers.insert(
            ReduceDerivation::build("factor".into(), vec!["false".into()]),
            Box::new(|datas| datas[0].clone()),
        );
        // ======================

        handlers.insert(
            ReduceDerivation::build(Self::DUMMY_START_SYMBOL.into(), vec!["S".into()]),
            Box::new(|vals| vals[0].clone()),
        );

        let mut res: RParser = RParser::default();
        res.action_table = action_table;
        res.handlers = handlers;
        res
    }

    // do shift-reduce parsing
    pub fn parse<T>(&self, tokens: Vec<T>) -> Result<ParsingTreeNode, Box<dyn Error>>
    where
        T: Token,
    {
        let mut shift_index = 0;
        let mut stack: Vec<NodePair> = Vec::new();

        stack.push(NodePair::new(
            ParsingTreeNode::build(Self::DUMMY_START_SYMBOL.into(), String::new(), Vec::new()),
            0,
        ));

        loop {
            let token_node = &tokens[shift_index].to_tree_node();

            let action = self
                .action_table
                .get_action(stack.last().unwrap().1, &token_node.symbol_type);

            match action {
                Some(Action::Shift(next_state)) => {
                    // shift
                    stack.push(NodePair::new(
                        tokens[shift_index].to_tree_node(),
                        *next_state,
                    ));
                    shift_index += 1;
                }
                Some(Action::Reduce(derivation)) => {
                    // pop right hand
                    let mut children: Vec<ParsingTreeNode> = Vec::new();
                    let mut datas = Vec::new();
                    for _ in 0..derivation.right.len() {
                        if let Some(top) = stack.pop() {
                            datas.push(top.0.data.clone());
                            children.push(top.0);
                        } else {
                            Err("parsing error: stack is empty.")?;
                        }
                    }

                    let children: Vec<_> = children.into_iter().rev().collect();
                    let datas: Vec<_> = datas.into_iter().rev().collect();
                    let handler = self.handlers.get(&derivation).unwrap();

                    // if the left hand side is dummy start symbol
                    // do nothing
                    if derivation.left == Self::DUMMY_START_SYMBOL {
                        stack.push(NodePair(
                            ParsingTreeNode::build(
                                derivation.left.to_string(),
                                handler(datas),
                                children,
                            ),
                            0,
                        ));
                        continue;
                    }

                    // goto[top_state(stack), X]
                    if let Action::Shift(next_state) = self
                        .action_table
                        .get_action(stack.last().unwrap().1, &derivation.left)
                        .unwrap()
                    {
                        stack.push(NodePair(
                            ParsingTreeNode::build(
                                derivation.left.to_string(),
                                handler(datas),
                                children,
                            ),
                            *next_state,
                        ));
                    } else {
                        Err("parsing error: invalid Shift action.")?;
                    }
                }
                Some(Action::Accept) => {
                    let res = stack.pop().unwrap().0;
                    return Ok(res);
                }
                _ => {
                    Err("parsing error: unknown.")?;
                }
            }
        }
    }
}
